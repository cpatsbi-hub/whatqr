<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR â†’ WhatsApp (Auto)</title>
  <style>
    :root{--bg:#f3f7fb;--card:#fff;--accent:#0a84ff;--muted:#6b7280;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:var(--bg);color:#08203a;padding:18px;display:flex;justify-content:center}
    .wrap{max-width:820px;width:100%}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(6,18,46,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    p.small{color:var(--muted);margin:0 0 12px}
    video{width:100%;border-radius:10px;background:#000;max-height:60vh;object-fit:cover}
    .row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}
    input,select{padding:10px;border-radius:8px;border:1px solid #e6eef9}
    .status{margin-top:10px;font-size:14px;color:#0b1220}
    .found{margin-top:10px;padding:10px;border-radius:8px;background:#f0ffef;color:#0a6a28}
    .note{margin-top:10px;color:var(--muted);font-size:13px}
    button{background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>QR â†’ WhatsApp (Auto open)</h1>
      <p class="small">Point camera at a QR code that contains a phone number. The app will automatically open WhatsApp and prefill the message when a number is detected.</p>

      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>

      <div class="row">
        <label style="min-width:140px;color:var(--muted)">Default country code</label>
        <input id="countryCode" value="91" style="width:120px" />
        <label style="min-width:120px;color:var(--muted)">Auto-open (seconds)</label>
        <input id="delaySec" type="number" value="0" min="0" style="width:80px" />
        <button id="startBtn">Start Camera</button>
        <button id="stopBtn">Stop</button>
      </div>

      <div id="status" class="status">Status: idle</div>
      <div id="foundBox" class="found" style="display:none"></div>
      <div class="note">Note: Browser requires HTTPS (or http://localhost). On mobile the wa.me link will attempt to open WhatsApp app.</div>
    </div>
  </div>

  <!-- jsQR -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
    // Message template (preserves line breaks and emojis)
    const messageTemplate = `Hi, 

I am Digital Officer from RBO.

The existing YONO app will soon be replaced by the new YONO 2.0.
All staff must get familiar with the new app to handle customer complaints effectively and provide the best service.

If you face any issues, please report them to the Digital Officer (RBO) via WhatsApp.

Android users, please check for email invitation.

ðŸ“± Android Download Link:

https://play.google.com/apps/testing/com.sbi.yono


iOS users, please check for email from Test flight.

ðŸ”‘ Referral Code: QHxudu05
`;

    // Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');
    const foundBox = document.getElementById('foundBox');
    const countryCodeInput = document.getElementById('countryCode');
    const delayInput = document.getElementById('delaySec');

    let stream = null;
    let scanning = false;
    let rafId = null;
    let track = null;
    let alreadyOpened = false; // prevent repeated auto-opens

    function setStatus(s){ status.textContent = 'Status: ' + s; }
    function showFound(msg){ foundBox.style.display='block'; foundBox.textContent = msg; }
    function hideFound(){ foundBox.style.display='none'; foundBox.textContent=''; }

    function cleanNumber(raw){
      if(!raw) return '';
      raw = raw.trim();
      raw = raw.replace(/^tel:/i,'');
      raw = raw.replace(/^whatsapp:/i,'');
      raw = raw.replace(/https?:\/\/(www\.)?wa\.me\//i,'');
      raw = raw.replace(/https?:\/\/(www\.)?api\.whatsapp\.com\/send\?phone=/i,'');
      // If QR contains other text, try to extract first occurrence of a number-like token
      // Keep + if present
      const plusExists = raw.includes('+');
      const digits = raw.replace(/[^0-9]/g,'');
      if(digits.length === 0) return '';
      return (plusExists ? '+' : '') + digits;
    }

    function ensureE164(number, defaultCountry){
      if(!number) return '';
      number = number.trim();
      if(number.startsWith('+')) return number.replace(/\D/g,'');
      const digits = number.replace(/\D/g,'');
      // If digits length looks like already includes country code (11-15), keep
      if(digits.length >= 11 && digits.length <= 15) return digits;
      // Otherwise prefix default country code if provided
      if(defaultCountry){
        const cc = (''+defaultCountry).replace(/\D/g,'');
        return cc + digits;
      }
      return digits;
    }

    function drawToCanvas(){
      const w = video.videoWidth;
      const h = video.videoHeight;
      if(w === 0 || h === 0) return null;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      return ctx.getImageData(0,0,w,h);
    }

    async function startCamera(){
      if(scanning) return;
      hideFound();
      alreadyOpened = false;
      setStatus('starting camera...');
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
        scanning = true;
        setStatus('camera running â€” scanning for QR...');
        rafId = requestAnimationFrame(tick);
      } catch(err){
        console.error(err);
        setStatus('camera error: ' + (err && err.message ? err.message : err));
      }
    }

    function stopCamera(){
      if(!scanning) return;
      scanning = false;
      if(rafId) cancelAnimationFrame(rafId);
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      setStatus('stopped');
    }

    function openWhatsAppAuto(numberDigits){
      if(alreadyOpened) return;
      alreadyOpened = true;
      // Build wa.me link: number should be digits only (no +)
      const waNumber = numberDigits.replace(/\D/g,'');
      const encoded = encodeURIComponent(messageTemplate);
      const waLink = `https://wa.me/${waNumber}?text=${encoded}`;
      // Stop camera before redirecting
      stopCamera();
      showFound('Opening WhatsApp for +' + waNumber);
      // Delay optionally (user can set 0)
      const delayMs = Math.max(0, parseInt(delayInput.value || '0', 10)) * 1000;
      setTimeout(()=>{
        // Use window.location to attempt same-tab redirect (works well on mobile to open app).
        // Using window.open may open in new tab; either is acceptable. We'll try same-tab for smoothness.
        window.location.href = waLink;
      }, delayMs);
    }

    function tick(){
      if(!scanning) return;
      try {
        const imageData = drawToCanvas();
        if(imageData){
          const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
          if(code && code.data){
            const raw = code.data;
            const cleaned = cleanNumber(raw);
            if(cleaned){
              const cc = countryCodeInput.value || '';
              const e164 = ensureE164(cleaned, cc);
              if(e164){
                showFound('Detected: ' + raw + ' â†’ ' + e164);
                setStatus('number detected');
                openWhatsAppAuto(e164);
                return; // stop processing further frames until camera stopped
              } else {
                showFound('Detected QR but could not form number from: ' + raw);
              }
            } else {
              showFound('QR contains no recognizable digits: ' + raw);
            }
          }
        }
      } catch(e){
        console.error(e);
      }
      rafId = requestAnimationFrame(tick);
    }

    // Buttons
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);

    // Auto-start camera on load if permissions available and secure origin
    (async function tryAutoStart(){
      setStatus('idle');
      // Do not aggressively prompt â€” leave start button for user to press.
      // If you'd prefer auto-start, uncomment the next line:
      // startCamera();
    })();

    // Clean up on page unload
    window.addEventListener('pagehide', stopCamera);
    window.addEventListener('beforeunload', stopCamera);
  </script>
</body>
</html>
