<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR â†’ WhatsApp (Auto open) â€” YONO 2.0</title>
  <style>
    :root{--bg:#f6fbff;--card:#fff;--accent:#0a84ff;--muted:#556;--good:#0a7a3a}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#072034;padding:18px;display:flex;justify-content:center}
    .wrap{max-width:880px;width:100%}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 20px rgba(10,20,40,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 12px;color:var(--muted)}
    video{width:100%;border-radius:10px;background:#000;max-height:60vh;object-fit:cover}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}
    input,select{padding:9px;border-radius:8px;border:1px solid #e7f0ff}
    button{background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(10,132,255,0.12)}
    .status{margin-top:10px;font-size:14px}
    .found{margin-top:10px;padding:10px;border-radius:8px;background:#f0fff3;color:var(--good)}
    .note{margin-top:10px;color:var(--muted);font-size:13px}
    .preview{white-space:pre-wrap;padding:12px;border-radius:8px;background:#fbfdff;border:1px solid #eef6ff;margin-top:12px}
    .fallback{margin-top:12px}
    code{background:#f3f7ff;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>QR â†’ WhatsApp (Auto open) â€” YONO 2.0</h1>
      <p class="lead">Start camera, point to a QR with an Indian phone number (10 digits). The page will detect the number, prefix <code>91</code>, and open WhatsApp with the message exactly as shown (line breaks & *asterisks* preserved).</p>

      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>

      <div class="controls">
        <label style="min-width:140px;color:var(--muted)">Default country code</label>
        <input id="countryCode" value="91" style="width:120px" />
        <button id="startBtn">Start Camera</button>
        <button id="stopBtn" class="ghost">Stop</button>
      </div>

      <div id="status" class="status">Status: idle â€” press "Start Camera"</div>
      <div id="foundBox" class="found" style="display:none"></div>

      <div class="preview" id="previewArea" aria-live="polite"></div>

      <div class="fallback" id="fallbackArea" style="display:none">
        <div class="note">If automatic opening is blocked by the browser, press the button below to open WhatsApp for the detected number.</div>
        <button id="fallbackOpen">Open WhatsApp now</button>
      </div>

      <div class="note">Use HTTPS or <code>http://localhost</code>. The app auto-opens only once per detection to avoid redirect loops.</div>
    </div>
  </div>

  <!-- jsQR -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
    // === Exact message received (keeps asterisks and line breaks) ===
    const messageTemplate = `Hi,I am Digital Officer from RBO.The existing YONO app will soon be replaced by the new YONO 2.0.All staff must get familiar with the new app to handle customer complaints effectively and provide the best service.*If you face any issues, please report them to the me via WhatsApp.*Android users, Please check your email to get link or use the following link.ðŸ“± Android Download Link:https://play.google.com/apps/testing/com.sbi.yonoiOS users, please check for mail from Testflight.ðŸ”‘ Referral Code: *QHxudu0*`;
    // =================================================================

    // Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');
    const foundBox = document.getElementById('foundBox');
    const previewArea = document.getElementById('previewArea');
    const fallbackArea = document.getElementById('fallbackArea');
    const fallbackOpen = document.getElementById('fallbackOpen');
    const countryCodeInput = document.getElementById('countryCode');

    previewArea.textContent = messageTemplate;

    let stream = null;
    let scanning = false;
    let rafId = null;
    let track = null;
    let alreadyOpened = false;
    let lastDetectedNumber = null;
    let pendingWaLink = null;

    function setStatus(txt){ status.textContent = 'Status: ' + txt; }
    function showFound(txt){ foundBox.style.display='block'; foundBox.textContent = txt; }
    function hideFound(){ foundBox.style.display='none'; foundBox.textContent=''; }

    function extractDigits(raw){
      if(!raw) return '';
      raw = String(raw).trim();
      raw = raw.replace(/^tel:/i,'').replace(/^whatsapp:/i,'');
      raw = raw.replace(/https?:\/\/(www\.)?wa\.me\//i,'').replace(/https?:\/\/(www\.)?api\.whatsapp\.com\/send\?phone=/i,'');
      // keep plus if present
      const token = raw.replace(/[^0-9+]/g,'');
      return token;
    }

    function normalizeToWaNumber(token, defaultCountryCode){
      if(!token) return '';
      token = token.replace(/\s+/g,'').replace(/[-()]/g,'');
      if(token.startsWith('+')) token = token.slice(1);
      token = token.replace(/[^0-9]/g,'');
      // remove leading zeros
      while(token.startsWith('0')) token = token.replace(/^0+/, '');
      if(token.length === 10){
        const cc = (''+defaultCountryCode).replace(/\D/g,'') || '91';
        return cc + token;
      }
      if(token.length >= 11 && token.length <= 15){
        return token;
      }
      return '';
    }

    function drawToCanvas(){
      const w = video.videoWidth;
      const h = video.videoHeight;
      if(w === 0 || h === 0) return null;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      return ctx.getImageData(0,0,w,h);
    }

    async function startCamera(){
      if(scanning) return;
      hideFound();
      alreadyOpened = false; lastDetectedNumber = null; pendingWaLink = null;
      fallbackArea.style.display = 'none';
      setStatus('requesting camera permission...');
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
        scanning = true;
        setStatus('camera running â€” scanning for QR...');
        // Important: this click is a user gesture â€” some browsers allow subsequent navigations originating from page after user gesture
        rafId = requestAnimationFrame(tick);
      } catch(err){
        console.error(err);
        setStatus('camera error: ' + (err && err.message ? err.message : err));
        alert('Camera error or permission denied: ' + (err && err.message ? err.message : err));
      }
    }

    function stopCamera(){
      if(!scanning) return;
      scanning = false;
      if(rafId) cancelAnimationFrame(rafId);
      if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
      setStatus('stopped');
    }

    function attemptAutoOpen(waNumber){
      if(alreadyOpened) return;
      alreadyOpened = true;
      stopCamera();
      showFound('Detected number: ' + waNumber + ' â€” opening WhatsApp...');
      const waLink = `https://wa.me/${waNumber}?text=${encodeURIComponent(messageTemplate)}`;
      pendingWaLink = waLink;
      // Try same-tab navigation first (better UX on mobile to open app)
      try {
        window.location.href = waLink;
        // If still on the page after short delay, show fallback
        setTimeout(()=>{
          if(!document.hidden){
            fallbackArea.style.display = 'block';
          }
        }, 800);
      } catch (e){
        fallbackArea.style.display = 'block';
      }
    }

    function tick(){
      if(!scanning) return;
      try {
        const imageData = drawToCanvas();
        if(imageData){
          const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
          if(code && code.data){
            const raw = code.data;
            const digitsToken = extractDigits(raw);
            if(digitsToken){
              const defaultCC = countryCodeInput.value || '91';
              const waNumber = normalizeToWaNumber(digitsToken, defaultCC);
              if(waNumber){
                if(lastDetectedNumber !== waNumber){
                  lastDetectedNumber = waNumber;
                  attemptAutoOpen(waNumber);
                  return;
                }
              } else {
                showFound('QR detected but number could not be normalized: ' + raw);
              }
            } else {
              showFound('QR detected but no digits recognized: ' + raw);
            }
          }
        }
      } catch (e){
        console.error(e);
      }
      rafId = requestAnimationFrame(tick);
    }

    fallbackOpen.addEventListener('click', () => {
      if(pendingWaLink){
        window.open(pendingWaLink, '_blank');
      } else if(lastDetectedNumber){
        window.open(`https://wa.me/${lastDetectedNumber}?text=${encodeURIComponent(messageTemplate)}`, '_blank');
      } else {
        alert('No detected number. Please scan the QR again.');
      }
    });

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);

    window.addEventListener('pagehide', stopCamera);
    window.addEventListener('beforeunload', stopCamera);

    setStatus('idle â€” press "Start Camera" to begin scanning.');
  </script>
</body>
</html>
